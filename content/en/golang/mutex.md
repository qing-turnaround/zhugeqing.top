---
date: 2022-04-01
description: "Go Mutex"
image: "/images/Go.jpg"
title: "å¹¶å‘åŸè¯­ä¹‹Mutex"
author: è¯¸è‘›é’
authorEmoji: ğŸ˜ƒ
pinned: false
tags:
- Go
series:
- 
---

## ä½¿ç”¨ç¤ºä¾‹
{{< boxmd >}}
* å¼€å¯10ä¸ªgoroutineï¼Œæ¯ä¸€ä¸ªgoroutineè¿›è¡Œè®¡æ•°1000000æ¬¡
{{< /boxmd >}}
```Go:main.go
package main

import (
	"sync"
)

type Counter struct {
	count int
	mu sync.Mutex
}

func main() {
	var wg sync.WaitGroup
	counter := &Counter{}
	wg.Add(10)
	for i := 0; i < 10; i++ {
		go func() {
			for j := 0; j < 1000000; j++ {
				counter.mu.Lock()
				counter.count++
				counter.mu.Unlock()
			}
			wg.Done()
		}()
	}
	wg.Wait()
	println("è®¡æ•°å¾—åˆ°çš„ç»“æœä¸ºï¼š", counter.count)
}
```

## Mutexåº•å±‚å®ç°
* Mutexä¸€å…±æœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªä¸º`state`ï¼Œä¸ºint32ç±»å‹ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªæ¯”ç‰¹ä¸º`mutexLocked`ï¼ˆè®°å½•è¿™ä¸ªé”æ˜¯å¦è¢«æŒæœ‰ï¼‰ï¼Œ`mutexWoken`ï¼ˆæ˜¯å¦æœ‰å”¤é†’çš„ goroutineï¼‰ï¼Œ`mutexStarving`ï¼ˆè®°å½•æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼‰ï¼Œå…¶ä½™æ¯”ç‰¹ç”¨äºè®°å½•ç­‰å¾…æ­¤é”çš„ goroutine æ•°ï¼ˆæœ€å¤§ä¸º`1<<(32-3)-1`ä¸ªï¼‰
* åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå½“ä¸€ä¸ª goroutine æœªè·å¾—é”æ—¶ä¼šå…ˆè¿›è¡Œè‡ªæ—‹å‡ æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å¾—åˆ°é”ï¼Œå°±åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰å¾…é˜Ÿåˆ—ä¼šæŒ‰ç…§FIFOçš„é¡ºåºæ’é˜Ÿã€‚å½“é”å¤„äºæœªè¢«æŒæœ‰çš„çŠ¶æ€æ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª goroutineä¼šè¢«å”¤é†’ï¼Œç„¶åéœ€è¦ä¸åæ¥çš„å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine è¿›è¡Œç«äº‰ï¼Œè¿™æ—¶ï¼Œåæ¥çš„ goroutine ä¼šæ›´æœ‰ä¼˜åŠ¿è·å¾—é”ï¼Œä¸€æ–¹é¢æ˜¯å®ƒä»¬ä»åœ¨cpuä¸Šè¿è¡Œï¼Œå¦ä¸€æ–¹é¢æ˜¯å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine å¯ä»¥æœ‰å¤šä¸ªï¼Œè€Œè¢«å”¤é†’çš„ goroutine åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„goroutine å¤§æ¦‚ç‡ä¼šå¤±è´¥ã€‚ç„¶åè¿™ä¸ª goroutine ä¼šè¢«é‡æ–°æ’å…¥åˆ°é˜Ÿåˆ—çš„é¦–éƒ¨ã€‚ä½†æ˜¯å½“ä¸€ä¸ª goroutine åŠ é”ç­‰å¾…æ—¶é—´è¶…è¿‡äº† 1ms ä»¥åï¼ŒMutexä¼šè¿›å…¥é¥¥é¥¿æ¨¡å¼ã€‚
* åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼ŒMutexçš„æ‰€æœ‰æƒä¼šä»æ‰§è¡ŒUnlockçš„ goroutine ç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨çš„ goroutineï¼Œåæ¥çš„goroutineä¹Ÿä¸ä¼šå†è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨goroutine åŠ é”ç­‰å¾…æ—¶é—´å°äº 1ms æˆ–è€…æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒMutexä¼šé‡æ–°åˆ‡æ¢ä¸ºæ­£å¸¸æ¨¡å¼