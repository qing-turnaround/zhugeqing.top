---
date: 2022-04-01
description: "Go Mutexä»¥åŠä¼˜åŒ–"
image: "/images/Go.jpg"
title: "å¹¶å‘åŸè¯­ä¹‹Mutex"
author: è¯¸è‘›é’
authorEmoji: ğŸ˜ƒ
pinned: false
tags:
- Go
series:
- 
---

## ä½¿ç”¨ç¤ºä¾‹
{{< boxmd >}}
* å¼€å¯10ä¸ªgoroutineï¼Œæ¯ä¸€ä¸ªgoroutineè¿›è¡Œè®¡æ•°1000000æ¬¡
{{< /boxmd >}}
```Go:main.go
package main

import (
	"sync"
)

type Counter struct {
	count int
	mu sync.Mutex
}

func main() {
	var wg sync.WaitGroup
	counter := &Counter{}
	wg.Add(10)
	for i := 0; i < 10; i++ {
		go func() {
			for j := 0; j < 1000000; j++ {
				counter.mu.Lock()
				counter.count++
				counter.mu.Unlock()
			}
			wg.Done()
		}()
	}
	wg.Wait()
	println("è®¡æ•°å¾—åˆ°çš„ç»“æœä¸ºï¼š", counter.count)
}
```

## Mutexåº•å±‚å®ç°
> sync.Mutex è®¾è®¡è€ƒé‡ï¼Œæ•ˆç‡ä¼˜å…ˆï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰ å’Œ å…¼é¡¾å…¬å¹³ï¼ˆé¥¥é¥¿æ¨¡å¼ï¼‰
> å¥½å‡ å¹´å‰çš„ç†è§£ï¼Œæœ‰ç©ºæ›´æ–°
* Mutexä¸€å…±æœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªä¸º`state`ï¼Œä¸ºint32ç±»å‹ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªæ¯”ç‰¹ä¸º`mutexLocked`ï¼ˆè®°å½•è¿™ä¸ªé”æ˜¯å¦è¢«æŒæœ‰ï¼‰ï¼Œ`mutexWoken`ï¼ˆæ˜¯å¦æœ‰å”¤é†’çš„ goroutineï¼‰ï¼Œ`mutexStarving`ï¼ˆè®°å½•æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼‰ï¼Œå…¶ä½™æ¯”ç‰¹ç”¨äºè®°å½•ç­‰å¾…æ­¤é”çš„ goroutine æ•°ï¼ˆæœ€å¤§ä¸º`1<<(32-3)-1`ä¸ªï¼‰
* åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå½“ä¸€ä¸ª goroutine æœªè·å¾—é”æ—¶ä¼šå…ˆè¿›è¡Œè‡ªæ—‹å‡ æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å¾—åˆ°é”ï¼Œå°±åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰å¾…é˜Ÿåˆ—ä¼šæŒ‰ç…§FIFOçš„é¡ºåºæ’é˜Ÿã€‚å½“é”å¤„äºæœªè¢«æŒæœ‰çš„çŠ¶æ€æ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª goroutineä¼šè¢«å”¤é†’ï¼Œç„¶åéœ€è¦ä¸åæ¥çš„å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine è¿›è¡Œç«äº‰ï¼Œè¿™æ—¶ï¼Œåæ¥çš„ goroutine ä¼šæ›´æœ‰ä¼˜åŠ¿è·å¾—é”ï¼Œä¸€æ–¹é¢æ˜¯å®ƒä»¬ä»åœ¨cpuä¸Šè¿è¡Œï¼Œå¦ä¸€æ–¹é¢æ˜¯å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine å¯ä»¥æœ‰å¤šä¸ªï¼Œè€Œè¢«å”¤é†’çš„ goroutine åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„goroutine å¤§æ¦‚ç‡ä¼šå¤±è´¥ã€‚ç„¶åè¿™ä¸ª goroutine ä¼šè¢«é‡æ–°æ’å…¥åˆ°é˜Ÿåˆ—çš„é¦–éƒ¨ã€‚ä½†æ˜¯å½“ä¸€ä¸ª goroutine åŠ é”ç­‰å¾…æ—¶é—´è¶…è¿‡äº† 1ms ä»¥åï¼ŒMutexä¼šè¿›å…¥é¥¥é¥¿æ¨¡å¼ã€‚
* åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼ŒMutexçš„æ‰€æœ‰æƒä¼šä»æ‰§è¡ŒUnlockçš„ goroutine ç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨çš„ goroutineï¼Œåæ¥çš„goroutineä¹Ÿä¸ä¼šå†è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨goroutine åŠ é”ç­‰å¾…æ—¶é—´å°äº 1ms æˆ–è€…æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒMutexä¼šé‡æ–°åˆ‡æ¢ä¸ºæ­£å¸¸æ¨¡å¼


## ä¼˜åŒ–é”

### ç¼©å°ä¸´ç•ŒåŒº

* é€šå¸¸æˆ‘ä»¬å¯èƒ½åœ¨ä½¿ç”¨`mutex.Lock()` ä¹‹ååŠ ä¸Š `defer mutex.Unlock()`, ä½†è¿™å¯èƒ½è®©ä¸´ç•ŒåŒºä»£ç å¢å¤§ï¼Œä»è€Œé™ä½æ€§èƒ½ï¼Œå¯ä»¥åœ¨é” ä¿æŠ¤å®Œä¸€æ®µ é€»è¾‘ä¹‹åç«‹é©¬é‡Šæ”¾é”ï¼ˆä½†æ˜¯éœ€è¦æ³¨æ„ä»¥åä¿®æ”¹ä»£ç ï¼Œä¸è¦é—æ¼è§£é”æ“ä½œï¼‰


### å‡å°é”çš„ç²’åº¦â€”â€”åˆ†æ®µé”

* ä¸€æŠŠå¤§é” â€”â€”ã€‹å¤šæŠŠå°é”ï¼Œç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ï¼ˆæ¯”å¦‚æˆ‘ä»¬ä¸ºäº†å¹¶å‘å®‰å…¨çš„mapï¼Œå¯èƒ½ä¼šä½¿ç”¨åˆ†æ®µé”Mapï¼‰

### è®©é”åšè¯»å†™åˆ†ç¦»

* sync.Mutex -> sync.RWMutex
* ä½¿ç”¨sync.Map

### æ— é”åŒ–

* å¯ä»¥ä½¿ç”¨ä¸€äº›åŸå­æ“ä½œä»£æ›¿é”


## é”çš„ä¸€äº›é¿å‘

* é”æ˜¯ä¸èƒ½æ‹·è´çš„ï¼ˆæˆ‘ä»¬ä¼ é€’é”çš„è¯ï¼Œéœ€è¦ä¼ é€’æŒ‡é’ˆï¼‰
* sync.Mutexæ˜¯ä¸å¯é‡å…¥çš„ï¼ˆå†æ¬¡åŠ é”ä¹‹å‰ï¼Œå¿…é¡»æ‰§è¡Œé‡Šæ”¾é”çš„æ“ä½œï¼‰
* atomic.Value åªä¿è¯`å­˜å‚¨å¯¹è±¡æ—¶`æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œè¦ä¹ˆå­˜æ”¾åªè¯»å¯¹è±¡ï¼Œè¦ä¹ˆå¯¹ å¯¹è±¡çš„æ“ä½œæ˜¯å¹¶å‘å®‰å…¨çš„
* `æˆ‘ä»¬å¯ä»¥ä½¿ç”¨go run -race ...` æ¥æ£€æµ‹å¹¶å‘ç«äº‰é—®é¢˜