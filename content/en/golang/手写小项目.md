---
date: 2021-06-11
description: "å®ç°"
image: "/images/Go.jpg"
title: "æ€§èƒ½ä¼˜åŒ–"
author: è¯¸è‘›é’
authorEmoji: ğŸ˜ƒ
pinned: false
tags:
- Go
  series:
-
---


## å®ç°ä¸€ä¸ªç®€å•çš„goroutine poolï¼ˆä»»åŠ¡æ± ï¼‰

* å®ç°ä¸€ä¸ªä»»åŠ¡æ± éœ€è¦è€ƒè™‘çš„ï¼š
  * æäº¤ä»»åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœGoroutineæ± å·²æ»¡ï¼Œé‚£ä¹ˆæ˜¯é˜»å¡ç­‰å¾…è¿˜æ˜¯æŠ›å¼ƒä»»åŠ¡ï¼Œäº¦æˆ–è€…ç¼“å­˜è¿™ä¸ªä»»åŠ¡
  * å¦‚æœç¼“å­˜è¿™ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªç¼“å­˜è®¾ç½®å¤šå¤§åˆé€‚

* ä»£ç å¦‚ä¸‹ï¼š
```go
package pool

import (
  "context"
  "fmt"
)

// é€‰é¡¹æ¨¡å¼ï¼šç”¨äºè®¾ç½®ä»»åŠ¡æ± çš„å±æ€§
type PoolOptions struct {
  // ä»»åŠ¡æ± çš„å¤§å°ï¼ˆå¯åŠ¨å¤šå°‘goroutineï¼‰
  poolSize int
  // ä»»åŠ¡æ± çš„ç¼“å†²åŒºå¤§å°ï¼ˆè®¾ç½®taskPoolèƒ½å­˜æ”¾å¤šå°‘ä»»åŠ¡ï¼‰
  bufferSize int
}

// é€‰é¡¹æ¨¡å¼ï¼šç”¨äºè®¾ç½®ä»»åŠ¡æ± çš„ç¼“å†²åŒºå¤§å°
func WithBufferSize(bufferSize int) func(*PoolOptions) {
  return func(options *PoolOptions) {
    options.bufferSize = bufferSize
  }
}

// é€‰é¡¹æ¨¡å¼ï¼šç”¨äºè®¾ç½®ä»»åŠ¡æ± çš„ Goroutine æ•°é‡
func WithPoolSize(poolSize int) func(*PoolOptions) {
  return func(options *PoolOptions) {
    options.poolSize = poolSize
  }
}

// task å®šä¹‰ä»»åŠ¡
type task func()

func (t task) Run() {
  // æ•è·panic
  defer func() {
    if err := recover(); err != nil {
      fmt.Println("task panic:", err)
    }

  }()
  // æ‰§è¡Œä»»åŠ¡
  t()
}

type TaskPool struct {
  // ä»»åŠ¡é˜Ÿåˆ—
  taskChan chan task
  // ä»»åŠ¡æ± çš„å…³é—­é€šé“
  closeChan chan struct{}
}

// NewTaskPool åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ± 
func NewTaskPool(options ...func(*PoolOptions)) *TaskPool {
  // è®¾ç½®é»˜è®¤å€¼
  poolOptions := &PoolOptions{
    poolSize:   10,
    bufferSize: 100,
  }
  // é€šè¿‡é€‰é¡¹æ¨¡å¼è®¾ç½®ä»»åŠ¡æ± çš„å±æ€§
  for _, option := range options {
    option(poolOptions)
  }
  // åˆ›å»ºä»»åŠ¡æ± 
  taskPool := &TaskPool{
    taskChan:  make(chan task, poolOptions.bufferSize),
    closeChan: make(chan struct{}),
  }

  // å¯åŠ¨ä»»åŠ¡æ± 
  for i := 0; i < poolOptions.poolSize; i++ {
    go func() {
      for {
        select {
        case task := <-taskPool.taskChan:
          task.Run()
        case <-taskPool.closeChan:
          return
        }
      }
    }()
  }

  return taskPool
}

// AddTask æ·»åŠ ä»»åŠ¡-å¯ä»¥é€šè¿‡contextæ§åˆ¶ æ·»åŠ ä»»åŠ¡çš„è¶…æ—¶
func (t *TaskPool) AddTask(task task, ctx context.Context) error {
  // å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­
  select {
  case t.taskChan <- task:
  case <-ctx.Done():
    return ctx.Err()
  }
  return nil
}

// Close å…³é—­ä»»åŠ¡æ± 
// è¯·ä¸è¦é‡å¤è°ƒç”¨ï¼Œå¦åˆ™ä¼španicï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨sync.Onceï¼Œä½†æœ‰æ—¶å€™ æˆ‘ä»¬ä¸åº”è¯¥è¿‡åº¦ä¿å§†å¼ è®¾è®¡ï¼‰
func (t *TaskPool) Close() {
  close(t.closeChan)
} 
```



## 