---
date: 2022-02-25                    
description: "Go mapåº•å±‚åˆ¨æ"
image: "/images/Go.jpg"
title: "Go map"
author: è¯¸è‘›é’
authorEmoji: ğŸ˜ƒ
pinned: false
tags:
- Go
series:
- 
---

## Go mapåŸºç¡€
> Go map åˆç§°ä¸º hashè¡¨ï¼ŒGoè¯­è¨€ mapé‡‡ç”¨çš„æ˜¯å¼€æ”¾å¯»å€æ³•é‡Œé¢çš„çº¿æ€§æ¢æµ‹ï¼Œçº¿æ€§æ¢æµ‹ç­–ç•¥æ˜¯é¡ºåºï¼ˆæ¯æ¬¡æ¢æµ‹é—´éš”ä¸º1ï¼‰çš„

### map çš„å£°æ˜ä¸åˆå§‹åŒ–

```Go
func defineMap() {
	// ç¬¬ä¸€ç§å£°æ˜æ–¹å¼
	var hash map[int]int
	hash[111] = 222 // panicï¼Œhashæ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œmapå€¼ä¸ºnilï¼Œ

	// ç¬¬äºŒç§å£°æ˜æ–¹å¼ï¼ˆmakeçš„ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨åˆå»ºmapçš„é•¿åº¦ï¼Œå¦‚æœä¸å¡«çš„è¯ï¼Œé»˜è®¤é•¿åº¦ä¸º 0ï¼‰
	hash = make(map[int]int, 1)
	hash[111] = 222 // success
}
```

### map çš„è®¿é—®
> å½“ä¸€ä¸ªé”®ä¸å­˜åœ¨äºmapä¸­æ—¶ï¼Œè®¿é—®çš„ç»“æœå°†ä¼šå¾—åˆ°valueç±»å‹çš„ é›¶å€¼
```Go
func accessMap() {
	hash := make(map[int]int)
	// ç¬¬ä¸€ç§è®¿é—®æ–¹å¼
	v := hash[0]
	fmt.Println(v)
	// ç¬¬äºŒç§è®¿é—®æ–¹å¼
	v, ok := hash[0]
	fmt.Println(v, ok)
}
```

### mapçš„èµ‹å€¼
```Go
func assignMap() {
	hash := make(map[int]int)
	// mapèµ‹å€¼ å°† key å’Œ valueç»‘å®šåœ¨ä¸€èµ·
	hash[2002] = 04
	// å¯ä»¥ ä½¿ç”¨deleteå¯¹ mapç›¸åŒçš„é”® è¿›è¡Œå¤šæ¬¡åˆ é™¤æ“ä½œï¼ˆä¸ä¼šå‡ºç°æŠ¥é”™çš„æƒ…å†µï¼‰
	for i := 0; i < 100; i++ {
		delete(hash, 2002) // å‰ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦è¿›è¡Œåˆ é™¤æ“ä½œçš„mapï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæŒ‡å®šéœ€è¦åˆ é™¤çš„key
	}
	fmt.Println(hash[2002])
}
```

### map keyçš„æ¯”è¾ƒ
> å¯¹äºkeyï¼Œåˆ‡ç‰‡ã€å‡½æ•°ã€mapæ˜¯ä¸å¯ä»¥æ¯”è¾ƒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸‰ç§ç±»å‹éƒ½ä¸èƒ½å½“åšmapçš„keyç±»å‹
```Go
func compareMapKey() {
	// hash := make(map[[]int]int) // error
	// hash := make(map[map[int]int]int) // error
	//hash := make(map[func()int]int) error
}
```

### map çš„å¹¶å‘å†²çª
> Goè¯­è¨€çš„å®˜æ–¹æ–‡æ¡£ä¸­å†™é“ï¼šè¦æ±‚æ‰€æœ‰mapæ“ä½œéƒ½äº’æ–¥å°†å‡æ…¢å¤§å¤šæ•°ç¨‹åºçš„é€Ÿåº¦ï¼Œè€Œåªä¼šå¢åŠ å°‘æ•°ç¨‹åºçš„å®‰å…¨æ€§â€œå³Goè¯­è¨€åªæ”¯æŒå¹¶å‘è¯»å–çš„åŸå› æ˜¯ä¿è¯å¤§å¤šæ•°åœºæ™¯ä¸‹çš„æŸ¥æ‰¾æ•ˆç‡
```Go
func concurrentMap() {
	hash := make(map[int]int)
	// 1. mapå¹¶ä¸æ”¯æŒå¹¶å‘è¯»å†™ï¼ˆfatal error: concurrent map read and map writeï¼‰
	/*
	   	// å†™æ“ä½œ
	   	go func() {
	   		for {
	   			hash[1] = 2
	   		}
	   	}()
	   	// è¯»æ“ä½œ
	   	go func() {
	   		for {
	   			_ = hash[1]
	   		}
	   	}()
	   	for i:=0; i<100;i++{}

	   }
	*/

	// 2. mapæ”¯æŒå¹¶å‘è¯»å–ï¼ˆsuccessï¼‰
	// å†™æ“ä½œ
	go func() {
		for {
			_, _ = hash[1]
		}
	}()
	// å†™æ“ä½œ
	go func() {
		for {
			_ = hash[1]
		}
	}()
	for i := 0; i < 100; i++ {}
}
```

## Go mapåº•å±‚

### Go mapåº•å±‚ç»“æ„
> æºç ä½ç½®ï¼šgo SDK\src\runtime\map.go
```Go
type hmap struct {
	// count è¡¨ç¤ºmapä¸­å…ƒç´ çš„ä¸ªæ•°
	count 	  int
	// flags è¡¨ç¤ºå½“å‰mapçš„çŠ¶æ€ï¼ˆæ˜¯å¦å¤„äºè¯»å†™çŠ¶æ€ç­‰ï¼‰
	flags     uint8
	// 2çš„Bæ¬¡å¹‚è¡¨ç¤ºå½“å‰mapä¸­æ¡¶çš„æ•°é‡ï¼Œ2^B=Buckets size
	B         uint8
	// noverflowä¸ºmapä¸­æº¢å‡ºæ¡¶çš„æ•°é‡ã€‚å½“æº¢å‡ºçš„æ¡¶å¤ªå¤šæ—¶ï¼Œmapä¼šè¿›è¡Œsame-size map growthï¼Œå…¶å®è´¨æ˜¯é¿å…æº¢å‡ºæ¡¶è¿‡å¤§å¯¼è‡´å†…å­˜æ³„éœ²ã€‚
	noverflow uint16
	// hashçš„ç§å­ï¼Œå®ƒèƒ½ä¸ºå“ˆå¸Œå‡½æ•°çš„ç»“æœå¼•å…¥éšæœºæ€§ï¼Œè¿™ä¸ªå€¼åœ¨åˆ›å»ºå“ˆå¸Œè¡¨æ—¶ç¡®å®šï¼Œå¹¶åœ¨è°ƒç”¨å“ˆå¸Œå‡½æ•°æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥
	hash0     uint32
	// bucketsæ˜¯æŒ‡å‘å½“å‰mapå¯¹åº”çš„æ¡¶çš„æŒ‡é’ˆ
	buckets    unsafe.Pointer
	// oldbucketsæ˜¯åœ¨mapæ‰©å®¹æ—¶å­˜å‚¨æ—§æ¡¶çš„ï¼Œå½“æ‰€æœ‰æ—§æ¡¶ä¸­çš„æ•°æ®éƒ½å·²ç»è½¬ç§»åˆ°äº†æ–°æ¡¶ä¸­æ—¶ï¼Œåˆ™æ¸…ç©º
	oldbuckets unsafe.Pointer
	// nevacuateåœ¨æ‰©å®¹æ—¶ä½¿ç”¨ï¼Œç”¨äºæ ‡è®°å½“å‰æ—§æ¡¶ä¸­å°äºnevacuateçš„æ•°æ®éƒ½å·²ç»è½¬ç§»åˆ°äº†æ–°æ¡¶ä¸­
	nevacuate  uintptr
	// extraå­˜å‚¨mapä¸­çš„æº¢å‡ºæ¡¶
	extra *mapextra
}

// æ¡¶ç»“æ„
type bmap struct {
	tophash [bucketCnt]uint8
	key     [bucketCnt]T // key æ•°ç»„
	value   [bucketCnt]T // value æ•°ç»„
}
```



## é—®ç­”

1. Golang Map åº•å±‚å®ç°

`Go è¯­è¨€mapåº•å±‚å®ç°æ˜¯ä¸€ä¸ªhashè¡¨ï¼Œå…¶è§£å†³hashç¢°æ’ä½¿ç”¨çš„æ˜¯å¼€æ”¾å¯»å€æ³•ä¸­çš„çº¿æ€§æ¢æµ‹ç­–ç•¥(æ¢æµ‹é—´éš”ä¸º1)ã€‚ä¸»è¦ç”±ä¸¤ä¸ªç»“æ„ä½“å®ç°ï¼Œä¸€ä¸ªæ˜¯hmapï¼ˆa header for a go mapï¼‰ï¼Œä¸€ä¸ªæ˜¯bmapï¼ˆa bucket for a go mapï¼‰ä¹Ÿå°±æ˜¯bucketã€‚å…¶ä¸­hmapçš„ä¸»è¦å­—æ®µæœ‰countï¼ˆintï¼Œmapä¸­çš„å…ƒç´ ä¸ªæ•°ï¼‰ï¼ŒBï¼ˆuint8ï¼Œ2çš„Bæ¬¡å¹‚å°±æ˜¯mapä¸­æ¡¶çš„æ•°é‡ï¼‰ï¼Œflagsï¼ˆuint8,è¡¨æ˜mapçš„ä¸€äº›çŠ¶æ€ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è¿›è¡Œæ‰©å®¹ï¼Œæ˜¯å¦åœ¨è¿›è¡Œè¯»å†™æ“ä½œï¼‰ï¼Œbucketsï¼ˆunsafe.Pointerï¼Œå½“å‰mapå¯¹åº”çš„æ¡¶çš„æŒ‡é’ˆï¼‰ï¼Œoldbucketsï¼ˆunsafe.Pointerï¼Œåœ¨mapè¿›è¡Œæ‰©å®¹æ—¶ï¼ŒæŒ‡å‘æ—§æ¡¶ï¼‰ï¼Œextraï¼ˆmapä¸­çš„æº¢å‡ºæ¡¶çš„æŒ‡é’ˆï¼‰ã€‚å¯¹äºbmapä¸»è¦å­—æ®µæœ‰tophashï¼ˆä¸€ä¸ªå›ºå®šé•¿åº¦ä¸º8çš„uint8æ•°ç»„ï¼Œå­˜å‚¨keyå¯¹åº”çš„hashå€¼å¾—é«˜8ä½ï¼‰ï¼Œkeyï¼ˆæ•°ç»„ï¼‰ï¼Œvalueï¼ˆæ•°ç»„ï¼‰ï¼Œoverflowï¼ˆæŒ‡å‘æº¢å‡ºæ¡¶çš„æŒ‡é’ˆï¼‰ï¼›å…¶ä¸­é™¤äº†tophashï¼Œå…¶ä»–å­—æ®µéƒ½ç”±ç¨‹åºåœ¨ç¼–è¯‘æ—¶é‡å»ºbmapç»“æ„ä½“äº§ç”Ÿï¼Œå¹¶ç¡®å®škeyï¼Œvalueï¼Œæ¡¶çš„å¤§å°ã€‚`

2. Golang Mapå¦‚ä½•æ‰©å®¹

`å…³äºmap æ‰©å®¹çš„æºç å‡½æ•°ä¸ºruntime.mapassignå‡½æ•°`
`æœ‰ä¸¤ç§æƒ…å†µå‘ç”Ÿæ—¶è§¦å‘å“ˆå¸Œçš„æ‰©å®¹ï¼š`
* `è£…è½½å› å­å·²ç»è¶…è¿‡ 6.5ï¼ˆè´Ÿè½½å› å­=å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡/æ¡¶çš„æ•°é‡ï¼‰`
> åŒå€æ‰©å®¹ï¼ˆä¹Ÿå°±æ˜¯æ¸è¿›å¼æ‰©å®¹ï¼‰ï¼ŒåŸæœ‰çš„æ¡¶ä¸ä¼šè¿›è¡Œä¸€æ¬¡æ€§æ¬è¿ï¼Œæ¯æ¬¡æœ€å¤šæ¬è¿ä¸¤ä¸ªï¼Œä¸€ä¸ªæ—§æ¡¶çš„æ•°æ®ä¼šåˆ†æµåˆ°ä¸¤ä¸ªæ–°æ¡¶ä¸Šï¼Œå¦‚æœæ•°æ®çš„hash&bucketMaskå°äºæˆ–ç­‰äºæ—§æ¡¶çš„å¤§å°ï¼Œåˆ™æ­¤æ•°æ®å¿…é¡»è½¬ç§»åˆ°å’Œæ—§æ¡¶ä½ç½®å®Œå…¨å¯¹åº”çš„æ–°æ¡¶ä¸­å»ï¼Œç†ç”±æ˜¯å½“å‰keyæ‰€åœ¨æ–°æ¡¶çš„åºå·ä¸æ—§æ¡¶æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚


* `æº¢å‡ºæ¡¶æ•°é‡è¿‡å¤šï¼›ï¼ˆç”±äº Go è¯­è¨€å“ˆå¸Œçš„æ‰©å®¹ä¸æ˜¯ä¸€ä¸ªåŸå­çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ runtime.mapassign å‡½æ•°è¿˜éœ€è¦åˆ¤æ–­å½“å‰å“ˆå¸Œæ˜¯å¦å·²ç»å¤„äºæ‰©å®¹çŠ¶æ€ï¼Œé¿å…äºŒæ¬¡æ‰©å®¹é€ æˆæ··ä¹±ï¼‰`
> ç­‰é‡æ‰©å®¹ï¼Œé‡æ–°æ’åˆ—ï¼Œè¿›è¡Œç®€å•çš„ç›´æ¥è½¬ç§»å³å¯ã€‚

