---
date: 2021-12-13
description: "Dockerfileçš„ä½¿ç”¨"
image: "images/docker.svg"
title: "Dockerfile"
author: è¯¸è‘›é’
authorEmoji: ğŸ˜ƒ
pinned: false
tags:
- docker
series:
- 
---

## Dockerfileé•œåƒçš„é€‰æ‹©åŸåˆ™ï¼ˆfromï¼‰
1. `å®˜æ–¹é•œåƒä¼˜äºéå®˜æ–¹çš„é•œåƒï¼Œå¦‚æœæ²¡æœ‰å®˜æ–¹é•œåƒï¼Œåˆ™å°½é‡é€‰æ‹©Dockerfileå¼€æºçš„`

2. `å›ºå®šç‰ˆæœ¬tagè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä½¿ç”¨latest`

3. `å°½é‡é€‰æ‹©ä½“ç§¯å°çš„é•œåƒ`

## Dockerfile Runå‘½ä»¤
> RUN ä¸»è¦ç”¨äºåœ¨Imageé‡Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ¯”å¦‚å®‰è£…è½¯ä»¶ï¼Œä¸‹è½½æ–‡ä»¶ç­‰ã€‚

### Runæ™®é€šå†™æ³•
```Dockerfile
FROM ubuntu:21.04
RUN apt-get update
RUN apt-get install -y wget
RUN wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz
RUN tar zxf ipinfo_2.0.1_linux_amd64.tar.gz
RUN mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo
RUN rm -rf ipinfo_2.0.1_linux_amd64.tar.gz
```

é€šè¿‡`docker image build -f dockerfile-run-1 -t ubuntu_run:1.0 .`æ¥æ„å»ºé•œåƒ
> `-f`æŒ‡å®šDockerfileæ–‡ä»¶åï¼Œ`-t`æŒ‡å®šimage tagï¼Œ`.`è¡¨ç¤ºDockerfileæ–‡ä»¶åœ¨å½“å‰ç›®å½•

é€šè¿‡`docker image history ubuntu_run:1.0`æ¥æŸ¥çœ‹åˆ†å±‚æƒ…å†µ
```Linux
IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
52b1dbec7f17   42 minutes ago   /bin/sh -c rm -rf ipinfo_2.0.1_linux_amd64.tâ€¦   0B        
70577d1a6d9f   42 minutes ago   /bin/sh -c mv ipinfo_2.0.1_linux_amd64 /usr/â€¦   9.36MB    
5755b7f81c88   42 minutes ago   /bin/sh -c tar zxf ipinfo_2.0.1_linux_amd64.â€¦   9.36MB    
3d1a66450a25   42 minutes ago   /bin/sh -c wget https://github.com/ipinfo/clâ€¦   4.85MB    
241a8d847076   45 minutes ago   /bin/sh -c apt-get install -y wget              3.73MB    
95ae86536030   45 minutes ago   /bin/sh -c apt-get update                       35.1MB    
d662230a2592   13 days ago      /bin/sh -c #(nop)  CMD ["bash"]                 0B        
<missing>      13 days ago      /bin/sh -c #(nop) ADD file:b94883edb5db8add8â€¦   80MB
```

`æ¯ä¸€è¡Œçš„RUNå‘½ä»¤éƒ½ä¼šäº§ç”Ÿä¸€å±‚image layer, å¯¼è‡´é•œåƒçš„è‡ƒè‚¿ã€‚`


### Runæ”¹è¿›å†™æ³•
```Dockerfile
FROM ubuntu:21.04
RUN apt-get update && \
    apt-get install -y wget && \
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz && \
    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz && \
    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo && \
    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz
```

é€šè¿‡`docker image build -f dockerfile-run-2 -t ubuntu_run:1.1 .`æ¥æ„å»ºé•œåƒ
> `-f`æŒ‡å®šDockerfileæ–‡ä»¶åï¼Œ`-t`æŒ‡å®šimage tagï¼Œ`.`è¡¨ç¤ºDockerfileæ–‡ä»¶åœ¨å½“å‰ç›®å½•
é€šè¿‡`docker image history ubuntu_run:1.1`æ¥æŸ¥çœ‹åˆ†å±‚æƒ…å†µ

```Linux
204507675bd9   37 seconds ago   /bin/sh -c apt-get update &&     apt-get insâ€¦   48.2MB    
d662230a2592   13 days ago      /bin/sh -c #(nop)  CMD ["bash"]                 0B        
<missing>      13 days ago      /bin/sh -c #(nop) ADD file:b94883edb5db8add8â€¦   80MB     
```


## æ–‡ä»¶å¤åˆ¶å’Œç›®å½•æ“ä½œ (ADD,COPY,WORKDIR)

> ä½¿ç”¨`copy`å’Œ`add`éƒ½å¯ä»¥å¾€é•œåƒé‡Œé¢å¤åˆ¶é•œåƒï¼Œè€Œ`add`ç›¸æ¯”äº`copy`ï¼Œä½¿ç”¨`add`å¾€é•œåƒé‡Œé¢å¤åˆ¶å‹ç¼©æ–‡ä»¶æ—¶ï¼Œ`add`ä¼šè‡ªåŠ¨è§£å‹ç¼©æ–‡ä»¶
> `workdir` ç›¸å½“äºæ˜¯`cd`(change directory)
### ADD
```Dockerfile
FROM python:3.9.5-alpine3.13
COPY hello.py /app/hello.py
```

### COPY
```Dockerfile
FROM python:3.9.5-alpine3.13
ADD hello.tar.gz /app/  
```

### WORKDIR
```Dockerfile
FROM python:3.9.5-alpine3.13
workdir /zhugeqing
ADD hello.tar.gz .
```

## æ„å»ºå‚æ•°å’Œç¯å¢ƒå˜é‡ (ARG å’Œ ENV)
> ARGï¼ˆargumentï¼‰` å’Œ `ENV ï¼ˆenvironmentï¼‰`éƒ½å¯ä»¥ç”¨æ¥è®¾ç½®ä¸€ä¸ªâ€œå˜é‡â€ã€‚ è®¾ç½®å¥½å˜é‡VERSIONä¹‹åå¯ä»¥ç”¨è¯­æ³•${VERSION}æ¥ä½¿ç”¨ã€‚

### ARG
```Dockerfile
FROM ubuntu:21.04
ENV VERSION=2.0.1
RUN apt-get update && \
    apt-get install -y wget && \
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-${VERSION}/ipinfo_${VERSION}_linux_amd64.tar.gz && \
    tar zxf ipinfo_${VERSION}_linux_amd64.tar.gz && \
    mv ipinfo_${VERSION}_linux_amd64 /usr/bin/ipinfo && \
    rm -rf ipinfo_${VERSION}_linux_amd64.tar.gz
```

### ENV
```Dockerfile
FROM ubuntu:21.04
ARG VERSION=2.0.1
RUN apt-get update && \
    apt-get install -y wget && \
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-${VERSION}/ipinfo_${VERSION}_linux_amd64.tar.gz && \
    tar zxf ipinfo_${VERSION}_linux_amd64.tar.gz && \
    mv ipinfo_${VERSION}_linux_amd64 /usr/bin/ipinfo && \
    rm -rf ipinfo_${VERSION}_linux_amd64.tar.gz
```

### ä¸åŒå¤„
> 1. ä½œç”¨èŒƒå›´ä¸åŒï¼Œ`env`è®¾ç½®çš„å˜é‡ä¼šåœ¨imageä¸­ä¿æŒï¼Œè€Œ`arg`è®¾ç½®çš„å˜é‡åªèƒ½åœ¨æ„å»ºçš„æ—¶å€™ç”¨åˆ°ã€‚
> 2. `arg`è®¾ç½®çš„å˜é‡ å¯ä»¥åœ¨é•œåƒ`build`çš„æ—¶å€™åŠ¨æ€ä¿®æ”¹, é€šè¿‡ `--build-arg`è¿›è¡Œä¿®æ”¹ï¼ˆä¾‹ï¼š`docker image build -f Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg VERSION=2.0.0 .`ï¼‰
> 3. ä½¿ç”¨åœºæ™¯åŒºåˆ†ï¼šå¦‚æœåœ¨å®¹å™¨è¿è¡Œçš„æ—¶å€™ä¹Ÿéœ€è¦ä½¿ç”¨åˆ°è®¾ç½®çš„å˜é‡ï¼Œé‚£ä¹ˆå€¾å‘äºä½¿ç”¨`env`ï¼Œå¦‚æœåªä¼šåœ¨buildé•œåƒçš„æ—¶å€™ä½¿ç”¨åˆ°è®¾ç½®çš„å˜é‡ï¼Œé‚£ä¹ˆå€¾å‘äºä½¿ç”¨`arg`

<img src="/images/docker/docker_environment_build_args.png" width="50%" height="50%">


## å®¹å™¨å¯åŠ¨å‘½ä»¤

### CMD
> CMDå¯ä»¥ç”¨æ¥è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶é»˜è®¤ä¼šæ‰§è¡Œçš„å‘½ä»¤ã€‚
>ç”¨æ³•ï¼š`CMD <shell å‘½ä»¤> `,`CMD ["<å¯æ‰§è¡Œæ–‡ä»¶æˆ–å‘½ä»¤>","<param1>","<param2>",...]`ã€‚

1. `å®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤`
2. `å¦‚æœdocker container runå¯åŠ¨å®¹å™¨æ—¶æŒ‡å®šäº†å…¶å®ƒå‘½ä»¤ï¼Œåˆ™CMDå‘½ä»¤ä¼šè¢«å¿½ç•¥`
3. `å¦‚æœå®šä¹‰äº†å¤šä¸ªCMDï¼Œåªæœ‰æœ€åä¸€ä¸ªä¼šè¢«æ‰§è¡Œ`

### ENTRYPOINT
>1. CMD è®¾ç½®çš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨docker container run æ—¶ä¼ å…¥å…¶å®ƒå‘½ä»¤ï¼Œè¦†ç›–æ‰ CMD çš„å‘½ä»¤ï¼Œä½†æ˜¯ ENTRYPOINT æ‰€è®¾ç½®çš„å‘½ä»¤æ˜¯ä¸€å®šä¼šè¢«æ‰§è¡Œçš„ã€‚
>2. ENTRYPOINT å’Œ CMD å¯ä»¥è”åˆä½¿ç”¨ï¼ŒENTRYPOINT è®¾ç½®æ‰§è¡Œçš„å‘½ä»¤ï¼ŒCMDä¼ é€’å‚æ•°

### Shell æ ¼å¼å’Œ Exec æ ¼å¼
> å¦‚æœæ˜¯æ‰§è¡Œshellè„šæœ¬ï¼ŒExecçš„å†™æ³•åº”è¯¥æ˜¯`CMD ["sh", "-c", "echo hello $NAME"]`

#### shell
`CMD echo "hello docker"`
`ENTRYPOINT echo "hello docker"`

#### Exec
`ENTRYPOINT ["echo", "hello docker"]`
`CMD ["echo", "hello docker"]`

## DockerfileæŠ€å·§

### åˆç†ä½¿ç”¨ç¼“å­˜
> dockeræ„å»ºé•œåƒçš„æ—¶å€™ä¼šä½¿ç”¨åˆ°ç¼“å­˜ï¼Œä½†å½“dockerfileæœ‰ä¸€å±‚æ²¡æœ‰ä½¿ç”¨ç¼“å­˜çš„æ—¶å€™ï¼Œä¹‹åçš„å‘½ä»¤å³ä½¿æ²¡æœ‰æ”¹å˜ä¹Ÿä¸ä¼šå†ä½¿ç”¨ç¼“å­˜ã€‚
`å°†æ— éœ€ä¸ä¼šè¿›è¡Œæ”¹å˜çš„å‘½ä»¤æ”¾åœ¨æœ€å‰é¢ï¼Œæœ‰å¯èƒ½ä¼šæ”¹åŠ¨çš„å‘½ä»¤æ”¾åœ¨æœ€åé¢`

### åˆç†ä½¿ç”¨.dockerignoreæ–‡ä»¶
> åœ¨.dockerignoreæ–‡ä»¶åŠ å…¥ä¸ç”¨å‘é€åˆ°Serverçš„ç›®å½•åæˆ–è€…æ—¶æ–‡ä»¶åï¼Œå¯ä»¥åœ¨å‘é€build contextæ—¶ï¼Œå°†è¿™äº›ç›®å½•æˆ–è€…æ–‡ä»¶è¿›è¡Œå¿½ç•¥

#### Docker build context
> åœ¨`æ„å»ºdockeré•œåƒ`çš„æ—¶å€™ï¼Œéœ€è¦æŠŠæ‰€éœ€è¦çš„æ–‡ä»¶ç”±Clientå‘ç»™Serverï¼Œè¿™äº›æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯`build context`

#### ä¸€èˆ¬æ„å»º
```linux
[root@zhugeqing ~]# docker image build -f dockerfile -t cache ./docker
Sending build context to Docker daemon   41.6kB
Step 1/6 : FROM ubuntu:21.04
 ---> d662230a2592
Step 2/6 : FROM python:3.9.5-alpine3.13
 ---> 46a196bf50ae
Step 3/6 : workdir /root
 ---> Using cache
 ---> 6f9c40c0c5be
Step 4/6 : RUN pip install flask
 ---> Using cache
 ---> 73e539437d7e
Step 5/6 : ADD hello.py /root
 ---> Using cache
 ---> 1950e2f31676
Step 6/6 : CMD ["python3","hello.py"]
 ---> Using cache
 ---> 3906ec34f79f
Successfully built 3906ec34f79f
Successfully tagged cache:latest
```

#### .dockerignoreæ–‡ä»¶
> .dockerignoreæ–‡ä»¶éœ€æ”¾åœ¨build contextæŒ‡å®šç›®å½•ä¸‹
```.dockerignore
image-golang
out
project1
project2
project4
dockerfile-run-1
dockerfile-run-2
hello.tar.gz
```

`è¿›è¡Œæ„å»º`
```
[root@zhugeqing ~]# docker image build -f dockerfile -t cache ./docker
Sending build context to Docker daemon  7.808kB
Step 1/6 : FROM ubuntu:21.04
 ---> d662230a2592
Step 2/6 : FROM python:3.9.5-alpine3.13
 ---> 46a196bf50ae
Step 3/6 : workdir /root
 ---> Using cache
 ---> 6f9c40c0c5be
Step 4/6 : RUN pip install flask
 ---> Using cache
 ---> 73e539437d7e
Step 5/6 : ADD hello.py /root
 ---> Using cache
 ---> 1950e2f31676
Step 6/6 : CMD ["python3","hello.py"]
 ---> Using cache
 ---> 3906ec34f79f
Successfully built 3906ec34f79f
Successfully tagged cache:latest
```

